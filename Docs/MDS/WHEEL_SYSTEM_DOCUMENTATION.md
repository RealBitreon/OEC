# ๐ก ูุธุงู ุฅุฏุงุฑุฉ ุนุฌูุฉ ุงูุญุธ - ุงูุชูุซูู ุงูุดุงูู

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุนุฌูุฉ ุงูุญุธ ูู ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ุงูุณุญูุจุงุช ุงูุนุดูุงุฆูุฉ ุงููุฑุฌุญุฉ ูู ุงููุณุงุจูุงุช. ูููุฑ ุงููุธุงู ุดูุงููุฉ ูุงููุฉุ ุฃูุงู ุนุงููุ ูุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ.

## โจ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. ุงูุณุญุจ ุงูุนุดูุงุฆู ุงููุฑุฌุญ (Weighted Random Draw)
- ูู ุทุงูุจ ูุญุตู ุนูู ูุฑุตุฉ ููููุฒ ุจูุงุกู ุนูู ุนุฏุฏ ุงูุชุฐุงูุฑ
- ุงุณุชุฎุฏุงู `crypto.randomBytes()` ูุถูุงู ุนุดูุงุฆูุฉ ุขููุฉ
- ุญุณุงุจ ุฏููู ููุงุญุชูุงููุงุช

### 2. ูุธุงู ุงูููู (Snapshot Locking)
- ููู ูุงุฆูุฉ ุงููุฑุดุญูู ูุจู ุงูุณุญุจ
- ููุน ุฃู ุชุนุฏููุงุช ุจุนุฏ ุงูููู
- ุญูุธ ูุณุฎุฉ ุซุงุจุชุฉ ูู ุงูุจูุงูุงุช

### 3. ุงูุชุญูู ูุงูุดูุงููุฉ
- ุฅูุดุงุก Hash ููุชุญูู ูู ุตุญุฉ ุงูุณุญุจ
- ุชุณุฌูู ูุงูู ูู Audit Logs
- ุนุฑุถ ูุนูููุงุช ุชูุตูููุฉ ุนู ุงูุณุญุจ

### 4. ุฅุฏุงุฑุฉ ุงููุดุฑ
- ุงูุชุญูู ูู ูุดุฑ ุงููุชุงุฆุฌ ููุนุงูุฉ
- ุฎูุงุฑุงุช ูุฅุฎูุงุก/ุฅุธูุงุฑ ุงุณู ุงููุงุฆุฒ
- ุฅุถุงูุฉ ุฑุณุงุฆู ุฅุนูุงููุฉ ูุฎุตุตุฉ

### 5. ุงูุฃูุงู ูุงูุตูุงุญูุงุช
- ุตูุงุญูุงุช ูุญุฏุฏุฉ (LRC_MANAGER, CEO)
- CEO ููุท ููููู ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฌูุฉ
- RLS policies ูุญูุงูุฉ ุงูุจูุงูุงุช

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### ุฌุฏูู `wheel_runs`
```sql
- id: UUID (Primary Key)
- competition_id: UUID (Foreign Key)
- locked_snapshot: JSONB (ูุงุฆูุฉ ุงููุฑุดุญูู ุงูููููุฉ)
- locked_at: TIMESTAMPTZ
- locked_by: UUID
- winner_id: UUID
- run_at: TIMESTAMPTZ
- run_by: UUID
- is_published: BOOLEAN
- show_winner_name: BOOLEAN
- winner_display_name: TEXT
- announcement_message: TEXT
- published_at: TIMESTAMPTZ
- published_by: UUID
- snapshot_metadata: JSONB
- draw_metadata: JSONB
```

#### Metadata Structures

**snapshot_metadata:**
```json
{
  "total_students": 25,
  "total_tickets": 150,
  "locked_by_username": "admin",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

**draw_metadata:**
```json
{
  "total_tickets": 150,
  "random_value": 87.34,
  "winner_ticket_index": 87,
  "draw_hash": "a1b2c3d4...",
  "run_by_username": "admin",
  "timestamp": "2024-01-15T11:00:00Z"
}
```

### Server Actions

#### `getEligibleStudents(competitionId)`
- ุฌูุจ ุฌููุน ุงูุทูุงุจ ุงููุคูููู
- ุญุณุงุจ ุฅุฌูุงูู ุงูุชุฐุงูุฑ ููู ุทุงูุจ
- ุญุณุงุจ ุงูุงุญุชูุงููุงุช
- ุชุฑุชูุจ ุญุณุจ ุนุฏุฏ ุงูุชุฐุงูุฑ

#### `lockSnapshot(competitionId)`
- ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
- ุงูุชุฃูุฏ ูู ูุฌูุฏ ุทูุงุจ ูุคูููู
- ููุน ุงูููู ุงููุชูุฑุฑ
- ุญูุธ ุงููุณุฎุฉ ุงูููููุฉ ูุน metadata
- ุชุณุฌูู ูู Audit Log

#### `runDraw(competitionId, seed?)`
- ุงูุชุญูู ูู ุงูููู ุงููุณุจู
- ุงูุณุญุจ ุงูุนุดูุงุฆู ุงููุฑุฌุญ ุจุงุณุชุฎุฏุงู crypto
- ุญุณุงุจ ุงููุงุฆุฒ
- ุฅูุดุงุก Hash ููุชุญูู
- ุญูุธ ุงููุชูุฌุฉ ูุน metadata
- ุชุณุฌูู ุชูุตููู ูู Audit Log

#### `publishResults(competitionId, settings)`
- ุงูุชุญูู ูู ุงููุดุฑ
- ุฅุนุฏุงุฏุงุช ุนุฑุถ ุงูุงุณู
- ุฑุณุงูุฉ ุงูุฅุนูุงู
- ุชุณุฌูู ูู Audit Log

#### `resetWheel(competitionId, reason)`
- ุตูุงุญูุฉ CEO ููุท
- ูุชุทูุจ ุณุจุจ ูุงุถุญ (10+ ุฃุญุฑู)
- ุญุฐู ุจูุงูุงุช ุงูุนุฌูุฉ
- ุชุณุฌูู ุญุฑุฌ ูู Audit Log

### ูุงุฌูุฉ ุงููุณุชุฎุฏู

#### Dashboard - WheelManagement.tsx

**ุงูููููุงุช:**
1. **ุงุฎุชูุงุฑ ุงููุณุงุจูุฉ**: ูุงุฆูุฉ ููุณุฏูุฉ ูููุณุงุจูุงุช ุงููุดุทุฉ/ุงููุคุฑุดูุฉ
2. **ูุธุฑุฉ ุนุงูุฉ**: ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช (ุทูุงุจุ ุชุฐุงูุฑุ ุญุงูุฉ ุงููููุ ุญุงูุฉ ุงูุณุญุจ)
3. **ุฌุฏูู ุงููุฑุดุญูู**: ุนุฑุถ ุชูุตููู ููู ุทุงูุจ ูุน ุงูุชุฐุงูุฑ ูุงูุงุญุชูุงููุงุช
4. **ุฅุฌุฑุงุกุงุช ุงูุนุฌูุฉ**: ุฃุฒุฑุงุฑ ูููููุ ุงูุณุญุจุ ุงููุดุฑุ ุงูุฅุนุงุฏุฉ

**ุณูุฑ ุงูุนูู:**
```
1. ุงุฎุชูุงุฑ ุงููุณุงุจูุฉ
   โ
2. ูุฑุงุฌุนุฉ ูุงุฆูุฉ ุงููุฑุดุญูู
   โ
3. ููู ุงููุงุฆูุฉ (๐)
   โ
4. ุชูููุฐ ุงูุณุญุจ (๐ก)
   โ
5. ุฅุฏุงุฑุฉ ุงููุดุฑ (๐ข)
   โ
6. (ุงุฎุชูุงุฑู) ุฅุนุงุฏุฉ ุงูุชุนููู (๐ - CEO ููุท)
```

#### Public Page - wheel/page.tsx

**ุงูุญุงูุงุช:**
1. **ูุง ุชูุฌุฏ ูุณุงุจูุฉ**: ุฑุณุงูุฉ ูุฏุนูุฉ ูููุชุงุจุนุฉ
2. **ูู ูุชู ุงูููู**: ุนุฑุถ ููุนุฏ ุงูุณุญุจ ุงููุชููุน
3. **ูููู ููู ูุชู ุงูุณุญุจ**: ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ูุนุฌูุฉ ุฎุงููุฉ
4. **ุชู ุงูุณุญุจ**: ุนุฑุถ ุงููุงุฆุฒ ูุน ุฅููุงููุฉ ุฅุนุงุฏุฉ ุงูุณุญุจ

**ุงููููุฒุงุช:**
- ุชุตููู ุฌุฐุงุจ ูุน animations
- ุนุฑุถ ูุนูููุงุช ุงููุงุฆุฒ (ุญุณุจ ุงูุฅุนุฏุงุฏุงุช)
- ุฑุณุงูุฉ ุงูุฅุนูุงู
- ูุนูููุงุช ุงูุชุญูู (Hash)
- ุฏุนูุฉ ูููุดุงุฑูุฉ ูู ุงููุณุงุจูุงุช ุงููุงุฏูุฉ

### API Endpoints

#### `GET /api/wheel/public?competitionId={id}`
- ุฌูุจ ุจูุงูุงุช ุงูุนุฌูุฉ ุงูููุดูุฑุฉ
- ุฅุฎูุงุก ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ
- ุนุฑุถ ุงูุจูุงูุงุช ุงูุนุงูุฉ ููุท

**Response:**
```json
{
  "wheelRun": {
    "id": "...",
    "competition_id": "...",
    "winner_id": "...",
    "locked_at": "...",
    "run_at": "...",
    "is_published": true,
    "show_winner_name": true,
    "winner_display_name": "ุงูุทุงูุจ ุงููุชููุฒ",
    "announcement_message": "ูุจุฑูู!",
    "locked_snapshot": [...],
    "draw_metadata": {...},
    "winner": {...}
  },
  "timestamp": "..."
}
```

## ๐ ุงูุฃูุงู

### 1. ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
```typescript
// ูู ูู server action
const { data: user } = await supabase
  .from('student_participants')
  .select('role, username')
  .eq('id', userId)
  .single()

if (!['LRC_MANAGER', 'CEO'].includes(user.role)) {
  throw new Error('ุบูุฑ ูุตุฑุญ')
}
```

### 2. Row Level Security (RLS)
```sql
-- ุนุฑุถ ุงููุชุงุฆุฌ ุงูููุดูุฑุฉ ููุฌููุน
CREATE POLICY "Public can view published wheel runs"
  ON wheel_runs FOR SELECT
  USING (is_published = true);

-- ุงููุฏุฑุงุก ูููููู ุฑุคูุฉ ูู ุดูุก
CREATE POLICY "Managers can view all wheel runs"
  ON wheel_runs FOR SELECT
  USING (role IN ('LRC_MANAGER', 'CEO'));
```

### 3. Audit Logging
ูู ุนูููุฉ ูุชู ุชุณุฌูููุง:
- `wheel_snapshot_locked`
- `wheel_draw_executed`
- `wheel_results_published`
- `wheel_results_unpublished`
- `wheel_reset`

### 4. Hash Verification
```typescript
const drawHash = crypto
  .createHash('sha256')
  .update(`${competitionId}-${winnerId}-${timestamp}-${seed}`)
  .digest('hex')
```

## ๐ ุงูุฅุญุตุงุฆูุงุช

### ุฏุงูุฉ `get_wheel_statistics()`
```sql
SELECT * FROM get_wheel_statistics('competition-id');
```

**Returns:**
- `total_students`: ุนุฏุฏ ุงูุทูุงุจ ุงููุคูููู
- `total_tickets`: ุฅุฌูุงูู ุงูุชุฐุงูุฑ
- `avg_tickets_per_student`: ูุชูุณุท ุงูุชุฐุงูุฑ ููู ุทุงูุจ
- `max_tickets`: ุฃุนูู ุนุฏุฏ ุชุฐุงูุฑ
- `min_tickets`: ุฃูู ุนุฏุฏ ุชุฐุงูุฑ
- `is_locked`: ูู ุชู ุงูููู
- `is_drawn`: ูู ุชู ุงูุณุญุจ
- `is_published`: ูู ุชู ุงููุดุฑ

## ๐จ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

### Animations
- ุนุฌูุฉ ุฏูุงุฑุฉ ูุน ุชุฃุซูุฑุงุช ุณูุณุฉ
- Confetti ุนูุฏ ุงูููุฒ
- Transitions ูุงุนูุฉ
- Loading states ูุงุถุญุฉ

### Responsive Design
- ูุนูู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ
- ุชุตููู ูุชุฌุงูุจ ููุฌุฏุงูู
- ุฃุฒุฑุงุฑ ูุงุถุญุฉ ูุณููุฉ ุงูุงุณุชุฎุฏุงู

### Accessibility
- ุฃููุงู ูุงุถุญุฉ ููุชุจุงููุฉ
- ูุตูุต ูุงุจูุฉ ูููุฑุงุกุฉ
- ุชุณููุงุช ูุงุถุญุฉ ููุฃุฒุฑุงุฑ
- ุฑุณุงุฆู ุฎุทุฃ ูููููุฉ

## ๐ ุงูุชุซุจูุช ูุงูุฅุนุฏุงุฏ

### 1. ุชุดุบูู SQL Migration
```bash
psql -h your-db-host -U your-user -d your-db -f supabase_wheel_enhanced.sql
```

### 2. ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
ุชุฃูุฏ ูู ูุฌูุฏ ูุณุชุฎุฏููู ุจุตูุงุญูุงุช:
- `LRC_MANAGER`: ูุฅุฏุงุฑุฉ ุงูุนุฌูุฉ
- `CEO`: ูุฅุนุงุฏุฉ ุงูุชุนููู

### 3. ุงุฎุชุจุงุฑ ุงููุธุงู
1. ุฅูุดุงุก ูุณุงุจูุฉ
2. ุฅุถุงูุฉ ุชุฐุงูุฑ ููุทูุงุจ
3. ููู ุงููุงุฆูุฉ
4. ุชูููุฐ ุงูุณุญุจ
5. ูุดุฑ ุงููุชุงุฆุฌ

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดููุฉ: "ูุง ููุฌุฏ ุทูุงุจ ูุคูููู"
**ุงูุญู:** ุชุฃูุฏ ูู ูุฌูุฏ ุชุฐุงูุฑ ูู ุฌุฏูู `tickets` ูููุณุงุจูุฉ

### ูุดููุฉ: "ุชู ููู ุงููุงุฆูุฉ ูุณุจูุงู"
**ุงูุญู:** ุงุณุชุฎุฏู `resetWheel()` (CEO ููุท) ุฃู ุงุฎุชุฑ ูุณุงุจูุฉ ุฃุฎุฑู

### ูุดููุฉ: "ูุดู ุงูุชุญูู ูู ุงููุณุชุฎุฏู"
**ุงูุญู:** ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู ูุตูุงุญูุงุช ุงููุณุชุฎุฏู

### ูุดููุฉ: ุงููุชุงุฆุฌ ูุง ุชุธูุฑ ูู ุงูุตูุญุฉ ุงูุนุงูุฉ
**ุงูุญู:** ุชุฃูุฏ ูู ูุดุฑ ุงููุชุงุฆุฌ ุนุจุฑ "ุฅุฏุงุฑุฉ ูุดุฑ ุงููุชูุฌุฉ"

## ๐ ุฃูุถู ุงูููุงุฑุณุงุช

### 1. ูุจู ุงูููู
- ุฑุงุฌุน ูุงุฆูุฉ ุงููุฑุดุญูู ุจุนูุงูุฉ
- ุชุฃูุฏ ูู ุตุญุฉ ุนุฏุฏ ุงูุชุฐุงูุฑ
- ุชุญูู ูู ุงูุงุญุชูุงููุงุช

### 2. ุนูุฏ ุงูุณุญุจ
- ุชุฃูุฏ ูู ูุฌูุฏ ุดููุฏ
- ุณุฌู ุงูููุช ูุงูุชุงุฑูุฎ
- ุงุญูุธ Hash ููุชุญูู

### 3. ุนูุฏ ุงููุดุฑ
- ุงุฎุชุฑ ุฅุนุฏุงุฏุงุช ุงูุนุฑุถ ุงูููุงุณุจุฉ
- ุฃุถู ุฑุณุงูุฉ ุชููุฆุฉ
- ุชุฃูุฏ ูู ุตุญุฉ ุงููุนูููุงุช

### 4. ุงูุฃูุงู
- ูุง ุชุดุงุฑู ุตูุงุญูุงุช CEO ุฅูุง ููุถุฑูุฑุฉ
- ุฑุงุฌุน Audit Logs ุจุงูุชุธุงู
- ุงุญุชูุธ ุจูุณุฎ ุงุญุชูุงุทูุฉ

## ๐ฏ ุงูุฎูุงุตุฉ

ูุธุงู ุนุฌูุฉ ุงูุญุธ ูููุฑ:
- โ ุณุญุจ ุนุงุฏู ูุดูุงู
- โ ุฃูุงู ุนุงูู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ
- โ ุฅุฏุงุฑุฉ ุณููุฉ
- โ ุชุณุฌูู ุดุงูู
- โ ูุฑููุฉ ูู ุงููุดุฑ

---

**ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ:** ูุฑูู ุชุทููุฑ ูุธุงู ุงููุณุงุจูุงุช
**ุขุฎุฑ ุชุญุฏูุซ:** ููุงูุฑ 2026
**ุงูุฅุตุฏุงุฑ:** 2.0 Enhanced
